cmake_minimum_required(VERSION 4.1)

# üî¥ –£–ë–†–ê–¢–¨: —ç—Ç–æ—Ç –±–ª–æ–∫ –ù–ï –î–û–õ–ñ–ï–ù –±—ã—Ç—å –¥–æ project()!
# ‚ùå –ù–ï–õ–¨–ó–Ø –≤—ã–∑—ã–≤–∞—Ç—å execute_process –¥–æ project() ‚Äî CMAKE_CXX_COMPILER_ID –µ—â—ë –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω!
# ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ SDK –ü–û–°–õ–ï project() –∏ –∑–∞–¥–∞–Ω–∏—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞.

project(cpp_journey LANGUAGES CXX)

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ ===
if(CMAKE_CXX_COMPILER STREQUAL "CMAKE_CXX_COMPILER-NOTFOUND" OR
        CMAKE_CXX_COMPILER MATCHES "apple.*clang")
    find_program(CLANGPP clang++ REQUIRED PATHS /opt/homebrew/bin /usr/bin)
    set(CMAKE_CXX_COMPILER ${CLANGPP})
endif()

# –ï–¥–∏–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)

# === –û–ø—Ä–µ–¥–µ–ª—è–µ–º SDK –¢–û–õ–¨–ö–û –ü–û–°–õ–ï project() –∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ ===
if(APPLE)
    # CMake ‚â• 3.15+ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç xcrun –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ CMAKE_OSX_SYSROOT=""
    # –ù–æ –º—ã —Å–¥–µ–ª–∞–µ–º —è–≤–Ω–æ ‚Äî –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
    if(NOT CMAKE_OSX_SYSROOT)
        execute_process(
                COMMAND xcrun --show-sdk-path
                OUTPUT_VARIABLE SDK_PATH
                OUTPUT_STRIP_TRAILING_WHITESPACE
                ERROR_QUIET
        )
        if(NOT SDK_PATH)
            message(FATAL_ERROR "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω macOS SDK. –í—ã–ø–æ–ª–Ω–∏: xcode-select --install")
        endif()
        set(CMAKE_OSX_SYSROOT "${SDK_PATH}" CACHE STRING "" FORCE)
        message(STATUS "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è macOS SDK: ${SDK_PATH}")
    endif()

    set(CMAKE_OSX_ARCHITECTURES "arm64")
endif()

# === –°—Ç–∞–Ω–¥–∞—Ä—Ç –∏ —Ñ–ª–∞–≥–∏ ===
set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# === –§–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ ===
if(CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
    # –ë–∞–∑–æ–≤—ã–µ —Ñ–ª–∞–≥–∏ ‚Äî —á–µ—Ä–µ–∑ add_compile_options (–ù–ï —á–µ—Ä–µ–∑ CMAKE_CXX_FLAGS!)
    add_compile_options(
            -Wall -Wextra -Wpedantic -Werror
            -Wshadow -Wnon-virtual-dtor -Wold-style-cast
            -Wcast-align -Wunused -Woverloaded-virtual
            -Wnull-dereference -Wdouble-promotion -Wformat=2
            -march=armv8.4-a+fp16+simd+crc+crypto
    )

    if(APPLE)
        # -stdlib=libc++ ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–ª—è Homebrew Clang!
        add_compile_options(-stdlib=libc++)
        add_link_options(-stdlib=libc++)

        # Debug + sanitizers —Ç—Ä–µ–±—É—é—Ç -O1 –Ω–∞ macOS
        add_compile_options($<$<CONFIG:Debug>:-O1>)
    endif()

    # –°–∞–Ω–∏—Ç–∞–π–∑–µ—Ä—ã
    option(ENABLE_ASAN "Enable AddressSanitizer" OFF)
    option(ENABLE_UBSAN "Enable UndefinedBehaviorSanitizer" OFF)

    if(ENABLE_ASAN)
        add_compile_options(-fsanitize=address -fno-omit-frame-pointer)
        add_link_options(-fsanitize=address)
    endif()
    if(ENABLE_UBSAN)
        add_compile_options(-fsanitize=undefined -fno-omit-frame-pointer)
        add_link_options(-fsanitize=undefined)
    endif()
endif()

# === –û—Å—Ç–∞–ª—å–Ω–æ–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ===
set(BUILD_TARGET "" CACHE STRING "Target to build (e.g. day1_raii)")
include_directories(libs)
include(FetchContent)

if(BUILD_TARGET AND EXISTS "${CMAKE_SOURCE_DIR}/src/${BUILD_TARGET}/CMakeLists.txt")
    add_subdirectory("src/${BUILD_TARGET}")
else()
    file(GLOB TARGET_DIRS RELATIVE ${CMAKE_SOURCE_DIR}/src ${CMAKE_SOURCE_DIR}/src/*)
    foreach(dir ${TARGET_DIRS})
        if(IS_DIRECTORY "${CMAKE_SOURCE_DIR}/src/${dir}" AND EXISTS "${CMAKE_SOURCE_DIR}/src/${dir}/CMakeLists.txt")
            add_subdirectory("src/${dir}")
        endif()
    endforeach()
endif()